{% extends "base.html" %}

{% block title %}Start Cultivation - AgriBalance{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Start New Cultivation</h1>
    <a href="{{ url_for('cultivation.list_cultivations') }}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Back
    </a>
</div>

<div class="grid-2">
    <div class="card">
        <h3 class="card-title mb-20">
            <i class="fas fa-seedling"></i> Cultivation Details
        </h3>
        
        <form method="POST" action="{{ url_for('cultivation.start_cultivation') }}">
            <div class="form-group">
                <label class="form-label" for="land_id">Select Land *</label>
                <select id="land_id" name="land_id" class="form-control" required>
                    <option value="">Choose a land</option>
                    {% for land in lands %}
                    <option value="{{ land.id }}" {{ 'selected' if selected_land and selected_land.id == land.id else '' }}>
                        {{ land.name }} ({{ land.land_size }} {{ land.land_size_unit }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="crop_name">Crop Name *</label>
                <input type="text" id="crop_name" name="crop_name" class="form-control" 
                       placeholder="e.g., Rice, Wheat, Tomato" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="variety">Variety/Type</label>
                <input type="text" id="variety" name="variety" class="form-control" 
                       placeholder="e.g., Basmati, Hybrid">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="planting_date">Planting Date</label>
                <input type="date" id="planting_date" name="planting_date" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="expected_harvest_date">Expected Harvest Date</label>
                <input type="date" id="expected_harvest_date" name="expected_harvest_date" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="area_to_use">Area to Cultivate (acres) *</label>
                <input type="number" id="area_to_use" name="area_to_use" class="form-control" 
                       step="0.01" min="0.01" placeholder="Enter cultivation area" required>
                <small class="form-text text-muted">Area must be within admin-set limits for your region</small>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="notes">Notes</label>
                <textarea id="notes" name="notes" class="form-control" 
                          placeholder="Any additional notes..."></textarea>
            </div>
            
            <button type="submit" name="save_cultivation" value="1" class="btn btn-primary btn-large">
                <i class="fas fa-play"></i> Start Cultivation
            </button>
        </form>
    </div>
    
    <div class="card">
        <h3 class="card-title mb-20">
            <i class="fas fa-info-circle"></i> Cultivation Limits & Pricing
        </h3>
        
        {% if quota_check %}
            {% if quota_check.allowed %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span>{{ quota_check.message }}</span>
                </div>
            {% else %}
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>{{ quota_check.message }}</span>
                </div>
            {% endif %}
            
            {% if quota_check.quota %}
            <div class="info-section">
                <h5><i class="fas fa-chart-bar"></i> Quota Information</h5>
                <ul>
                    <li><strong>Total Allowed:</strong> {{ quota_check.quota.total_allowed_area }} {{ quota_check.quota.area_unit }}</li>
                    <li><strong>Already Allocated:</strong> {{ quota_check.quota.allocated_area }} {{ quota_check.quota.area_unit }}</li>
                    <li><strong>Remaining:</strong> {{ quota_check.quota.remaining_area() }} {{ quota_check.quota.area_unit }}</li>
                    {% if quota_check.quota.max_per_farmer %}
                    <li><strong>Max Per Farmer:</strong> {{ quota_check.quota.max_per_farmer }} {{ quota_check.quota.area_unit }}</li>
                    {% endif %}
                    {% if quota_check.quota.harvest_season_start and quota_check.quota.harvest_season_end %}
                    <li><strong>Harvest Season:</strong> {{ quota_check.quota.harvest_season_start.strftime('%b %d, %Y') }} - {{ quota_check.quota.harvest_season_end.strftime('%b %d, %Y') }}</li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
        {% else %}
        <div class="empty-state">
            <i class="fas fa-info-circle"></i>
            <h3>Admin-Controlled Cultivation</h3>
            <p>Cultivation areas and prices are managed by administrators based on regional demand and market conditions. Fill in the cultivation details and submit to check availability.</p>
            <div class="mt-20">
                <h5><i class="fas fa-check-circle"></i> What You Get:</h5>
                <ul class="text-left">
                    <li>Cultivation within admin-approved limits</li>
                    <li>Automatic price setting based on harvest period</li>
                    <li>Fair pricing for your area and season</li>
                    <li>Quota tracking and availability</li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Available Quotas Section -->
{% if available_quotas %}
<div class="card" style="margin-top: 1rem;">
    <h3 class="card-title mb-20">
        <i class="fas fa-balance-scale"></i> Available Quotas for Your Locations
    </h3>
    <table class="table">
        <thead>
            <tr>
                <th>Crop</th>
                <th>Location</th>
                <th>Total Area</th>
                <th>Remaining</th>
                <th>Max Per Farmer</th>
                <th>Season</th>
            </tr>
        </thead>
        <tbody>
            {% for quota in available_quotas %}
            <tr>
                <td><strong>{{ quota.crop_name }}</strong></td>
                <td>
                    {% if quota.district %}{{ quota.district }}{% endif %}
                    {% if quota.state %}, {{ quota.state }}{% endif %}
                </td>
                <td>{{ quota.total_allowed_area }} {{ quota.area_unit }}</td>
                <td>{{ quota.remaining_area() }} {{ quota.area_unit }}</td>
                <td>{{ quota.max_per_farmer or 'No limit' }} {{ quota.area_unit if quota.max_per_farmer else '' }}</td>
                <td>
                    {% if quota.harvest_season_start %}
                        {{ quota.harvest_season_start.strftime('%b %Y') }} - {{ quota.harvest_season_end.strftime('%b %Y') if quota.harvest_season_end else 'Ongoing' }}
                    {% else %}
                        Year-round
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
